<!DOCTYPE html>
<html>
  <head>
    <meta charset='utf-8'>
    <meta http-equiv="X-UA-Compatible" content="chrome=1">
    <meta name="viewport" content="width=640">

    <link rel="stylesheet" href="stylesheets/core.css" media="screen">
    <link rel="stylesheet" href="stylesheets/mobile.css" media="handheld, only screen and (max-device-width:640px)">
    <link rel="stylesheet" href="stylesheets/github-light.css">

    <script type="text/javascript" src="javascripts/modernizr.js"></script>
    <script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js"></script>
    <script type="text/javascript" src="javascripts/headsmart.min.js"></script>
    <script type="text/javascript">
      $(document).ready(function () {
        $('#main_content').headsmart()
      })
    </script>
    <title>Mockspec by jrvliet</title>
  </head>

  <body>
    <a id="forkme_banner" href="https://github.com/jrvliet/mockspec">View on GitHub</a>
    <div class="shell">

      <header>
        <span class="ribbon-outer">
          <span class="ribbon-inner">
            <h1>Mockspec</h1>
            <h2>Full Pipeline</h2>
          </span>
          <span class="left-tail"></span>
          <span class="right-tail"></span>
        </span>
      </header>

      <section id="downloads">
        <span class="inner">
          <a href="https://github.com/jrvliet/mockspec/zipball/master" class="zip"><em>download</em> .ZIP</a><a href="https://github.com/jrvliet/mockspec/tarball/master" class="tgz"><em>download</em> .TGZ</a>
        </span>
      </section>


      <span class="banner-fix"></span>


      <section id="main_content">
        <h2>
<a id="welcome-to-mockspec" class="anchor" href="#welcome-to-mockspec" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Welcome to Mockspec</h2>

<p>This is the main page for the mockspec code. This code generates and analyzes synthetic quasar absorption line profiles in the circumgalactic medium around galaxies simulated with ART. It has been developed by <a href="http://astronomy.nmsu.edu/jrvander">Jacob Vander Vliet</a> and <a href="http://astronomy.nmsu.edu/cwc">Dr. Chris Churchill</a> at <a href="astronomy.nmsu.edu">New Mexico State University</a>. The full details of how the code works can be found: <a href="http://adsabs.harvard.edu/abs/2014arXiv1409.0916C">here</a> and <a href="http://adsabs.harvard.edu/abs/2015ApJ...802...10C">here</a>. </p>

<h3>
<a id="overview" class="anchor" href="#overview" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Overview:</h3>

<p>This code generates synthetic quasar absorption lines by running lines of sight (LOS) through a simulated galaxy made with ART.  This repository has all the code required to generate and analyze the spectra. </p>

<h3>
<a id="before-you-run-the-code" class="anchor" href="#before-you-run-the-code" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Before you run the code:</h3>

<p>There are a few steps that need to be taken before the code can be run. </p>

<ol>
<li> To run this code, the following python packages need to be installed:
<ul>
<li> numpy
</li>
<li> pytables
</li>
<li> panda
</li>
<li> astropy
</li>
</ul>

</li>
<li> Get the simulation in the correct format. ART output the entire simulation box, typically 10Mpc along a side. Mockspec does not run on these boxes. It instead runs on a small box selected from the large box. This selection is done using ANA. There are two versions of ANA. The following instructions are for the version written by Daniel Ceverino. Usually, you should use the second version. Daniel's version is found in funcs/ana/. Running ANA requires the following simulation files:
<ul>
<li> 10MpcBox_csf512.d
</li>
<li> 10MpcBox_HartGal_csf_a0.300.d
</li>
<li> 10MpcBox_HartGal_csf.d
</li>
<li> PMcrda0.300.DAT
</li>
<li> PMcrs0a0.300.DAT    
</li>
<li> sf.dat
</li>
</ul>
To control the run of ANA, there are two control file: 
<ul>
<li> control.dat 
</li>
<li> schedule_R.dat
</li>
</ul>    
Schedule_R.dat has most of the controls in it. The top section has flags as to what the code should read in and what files it should produce. The sections that definitely need to have a 1 are:
<ul>
<li> Read N-body file
</li>
<li> Read stellar file
</li>
<li> Read HYDRO file
</li>
<li> Set units and global variables
</li>
<li> Find halo center using particle distribution
</li>
<li> Compute angular momentum
</li>
<li> density, temperature, entropy profiles and Rvir calculation
</li>
<li> Binary file with gas cells inside 4Rvir-box
</li>
<li> Binary file with gas cells inside 4Rvir-box (metalliciites)
</li>
</ul>

<p>
ANA has an interesting behaviour where it finds the center of the galaxy, but is super bad at it. You need to find the center with Rockstar (found <a href="astronomy.nmsu.edu/jrvander/mockspec/centers.tar.gz">here</a> and put it in manually. The Rockstar center is found in the halos* files and is the first halo listed. These files contain ALL the halos in the simulation, ordered by mass. Since we want the host galaxy, use the first line. 
</p>


<p>
The coordinates are put in on the lines "xuser", "yuser", "zuser". The flag in front of "ioptCenter=1/2/3--&gt;potential/HF/IFRIT" should be set to 2, indicating the center is from a halo finder if the simulation is a VELA, or 1 (indicating the center is the location of maximum potential) if the simulation is a dwarf. This setting is the biggest source of uncertainty in ANA. Always check the output Mvir and Rvir against the value from Rockstar, which is recorded along with the centers. If they differ by a significant amount, change the setting of ioptcenter and try again. 
</p>
<p>
Line 30 of schedule_R.dat should be the single word 'test'. This is the prefix appended to the front of all files created by ANA. Change this to the galID, such as D9m4a or vela20v2.
</p>
<p>
The rest of the file should not be touched. 
</p>
<p>
To setup control.dat, only change after the three repeated lines of "1. 129". The single number on the next line is the number of snapshots to run ANA on. Leave this as one. The rest of the file is the list of expansion parameters of the snapshots. Even if there are several numbers listed here, ANA will only run on the first one, since the number of snapshots to run is set to 1. Also, ensure the first line, labeled jobname1, is set to 10MpcBox_HartGal_csf. This is the large 10Mpc box that will be read. 
</p>



<p>
Once both control.dat and schedule_R.dat are set, run ana.R.exe.  The file needed is the GZ file. The necessary output files are named &lt;galID&gt;_GZa&lt;expansion parameter&gt;.txt (the gas box) and summary.txt (summary file). 
</p>


</li>
<li> To use the summary file, its contents need to be added to the galaxy's summary file. These files are named &lt;galID&gt;.dat and are located in the summaries directory. These properties are required for the rest of the pipeline, mainly cellfinder, to work. The rotation matrix <em>a</em> is one of the most important results from ANA and the main reason we still use it. 





</li>
<li> The pipeline does not run on the binary files. It runs on an ASCII version of the file. To convert, use readbinary.exe. Run it with the format of 


        <p>
            readbinary.exe &lt;binary file&gt; &lt;name of output ASCII file&gt; GZ
        </p>


The name of the output ASCII file should be the name of the binary file, but with .dat replaced with .txt


</li>
<li> In most cases, Ceverino's version of ANA is not the version you should use. You should use the version written by Kenza Arraki. It is found in ana/justGZ/. Depending on the type of simulation you are analyzing, you may have to change some of the code. The line to look it is line 294 of ART_IO.F. It should look like:
<p>
integer lspecies(nspec)
</p>
<p>
If you are analyzing a Vela of the 4th generation, this needs to be changed to:
</p>
<p>
integer*8 lspecies(nspec)
</p>
<p>
The other change is to use the correct a_setup.h file. The justGZ directory has three available: Dwarf_a_setup.h, VELA_a_setup.h, VELA4_a_setup.h. Copy the one you are using to a_setup.h and make the code. 

</p>
<p> To use this version, the directory has to be set up properly. There needs to be a directory called outputs in the location where you are running the code. This this directory there needs to be a directory called rockstar. There also needs to be find called input_.txt. This file is output by the Rockstar code. 
<p> When the code is run, it will output the GZ box in ASCII into the output directory. It will be called _GZa.txt. There will also be a file called ioread.txt which is the screen output of ANA and a file called rotmat_a.txt. This contains the rotation matrix for the box. 


</p></p>
</li>
<li> Configure the run. The parameters of the run are set in the mockspec.config file. There are three sections in this file. The first describes the galaxy and basic code parameters.  These are mostly self-explanatory. The      number of cores only affects the codes that can be run with parallization, namely cellfinder. The root location is not used by anything, so don't change it
    

The second section determines which codes will be run. A 1 turns the code on, a 0 turns it off. 


The third section describes the ions to be probed and what instrument will be used for that ion. 




</li>
<li> Ensure the directory has all required files, namely the galaxy file 




</li>
<li> Make all compiled codes. This includes: rates, cellfinder, los7, specsynth, sysabs, and cullabs. To make rates, you need to download and untar the following files:
<ul>
<li> <a href="http://astronomy.nmsu.edu/jrvander/mockspec/coolingtables.tar.gz">coolingtables.tar.gz</a>
</li>
<li> <a href="http://astronomy.nmsu.edu/jrvander/mockspec/lapack.tar.gz">lapack.tar.gz</a>
</li>
<li> <a href="http://astronomy.nmsu.edu/jrvander/mockspec/slatec.tar.gz">slatec.tar.gz</a>
</li>
</ul>
</li>
</ol>
  

<h3>
<a id="running-the-code" class="anchor" href="#running-the-code" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Running the code</h3>

<p>The main driver is mockspec.py. Run this in the directory with the snapshot. Everything is controlled by the mockspec.config file. </p>

<h3>
<a id="outputs" class="anchor" href="#outputs" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Outputs</h3>

<p>The code generates several files along the way:</p>

<ul>
<li> los&lt;losnum&gt;.cellID.dat: Generated by cellfinder, this is a list of the cellIDs of cells along the LOS
</li>
<li> &lt;galID&gt;.&lt;ion&gt;.los&lt;losnum&gt;.dat: Generated by idcells, this contains all properties of the cells along the LOS as taken from the simulation output. 
</li>
<li> &lt;galID&gt;.&lt;ion&gt;.los&lt;losnum&gt;.losdata: Generated by los7, this contains derived properties of each cell along the LOS. 
</li>
<li> &lt;galID&gt;.&lt;ion&gt;.los&lt;losnum&gt;.lines: Generated by los7, this contains the column density and doppler parameter for each cell only the LOS. 
</li>
<li> &lt;galID&gt;.&lt;ion&gt;.los&lt;losnum&gt;.&lt;ion&gt;&lt;transition&gt;.spec: Generated by specsynth, this contains the spectrum of the absorption. If the ion is a doublet, two of these files are created, one for each transition.
</li>
<li> &lt;galID&gt;.&lt;ion&gt;.los&lt;losnum&gt;.sysabs: Generated by sysanal, this contains the equivalent width and AOD column density of each transition. This file is only generated if absorption is detected. 
</li>
<li> .&lt;galID&gt;.&lt;ion&gt;.los&lt;losnum&gt;regabs: Generated by sysanal, this file is only generated if there are multiple absorption regions detected. 
</li>
<li> &lt;galID&gt;.&lt;ion&gt;.ALL.sysabs: Generated by cullabs, this is all sysabs files culminated into one file.  
</li>
</ul>

<h3>
<a id="reading-the-outputs" class="anchor" href="#reading-the-outputs" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Reading the Outputs</h3>

<p>Most of the outputs are stored in <a href="https://www.hdfgroup.org/&gt;the%20HDF5&lt;/a&gt;%20file%20format.%20This%20format%20results%20in%20smaller%20output%20files%20that%20write%20and%20read%20faster%20than%20plain%20text%20and%20is%20the%20industry%20standard.%20To%20access%20the%20files,%20it%20is%20helpful%20to%20know%20the%20columns%20included%20in%20each%20file:&lt;/p&gt;%0A%0A&lt;p&gt;abs_cells:&lt;/p&gt;%0A%0A&lt;ul&gt;%0A&lt;li&gt;%20**LOS**:%20Line%20of%20sight%20number%0A&lt;li&gt;%20**D**:%20Impact%20parameter%0A&lt;li&gt;%20**cellID**:%20Identification%20number%20of%20the%20cell%0A&lt;li&gt;%20**redshift**:%20Redshift%20of%20the%20cell,%20based%20on%20the%20redshift%20of%20the%20galaxy%20and%20the%20cell's%20line-of-sight%20velocity%0A&lt;li&gt;%20**logN**:%20Column%20density%20of%20the%20ion%20in%20the%20cell%0A&lt;li&gt;%20**dobbler_b**:%20Doppler%20b%20parameter%20=%20sqrt(2*k*T/m)%0A&lt;li&gt;%20**x**:%20x-coordinate%20of%20the%20cell%20in%20the%20box's%20coordinate%20system%20in%20%5Bkpc%5D%0A&lt;li&gt;%20**y**:%20y-coordinate%20of%20the%20cell%20in%20the%20box's%20coordinate%20system%20in%20%5Bkpc%5D%0A&lt;li&gt;%20**z**:%20z-coordinate%20of%20the%20cell%20in%20the%20box's%20coordinate%20system%20in%20%5Bkpc%5D%0A&lt;li&gt;%20**vx**:%20vx-component%20of%20the%20cell's%20velocity%20in%20the%20box's%20coordinate%20system%20in%20%5Bkm/s%5D%0A&lt;li&gt;%20**vy**:%20vy-component%20of%20the%20cell's%20velocity%20in%20the%20box's%20coordinate%20system%20in%20%5Bkm/s%5D%0A&lt;li&gt;%20**vz**:%20vz-component%20of%20the%20cell's%20velocity%20in%20the%20box's%20coordinate%20system%20in%20%5Bkm/s%5D%0A&lt;li&gt;%20**galactocentric_d**:%20Distance%20between%20the%20cell%20and%20the%20center%20of%20the%20galaxy%20%5Bkpc%5D%0A&lt;li&gt;%20**log_nH**:%20Log%20of%20the%20gas%20density%20%5Bnum/cc%5D%20of%20the%20cell%0A&lt;li&gt;%20**log_T**:%20Log%20of%20the%20temperature%20%5BK%5D%20of%20the%20cell%0A&lt;li&gt;%20**cell_size**:%20Size%20of%20the%20cell%20%5Bkpc%5D%0A&lt;li&gt;%20**SNII**:%20Contribution%20to%20the%20metal%20mass%20fraction%20from%20SNII%0A&lt;li&gt;%20**SNIa**:%20Contribution%20to%20the%20metal%20mass%20fraction%20from%20SNIa%0A&lt;li&gt;%20**alpha_Zmet**:%20Metallicity%20of%20the%20cell%20in%20standard%20Z%20style%0A&lt;li&gt;%20**ion_density**:%20Density%20of%20the%20ion%20in%20the%20cell%20%5Bnum/cc%5D%0A&lt;/ul&gt;%0A%0A&lt;p&gt;ALL.sysabs:&lt;/p&gt;%0A%0A&lt;ul&gt;%0A&lt;li&gt;%20**los**:%20Line%20of%20sight%20number%0A&lt;li&gt;%20**D**:%20Impact%20parameter%20%5Bkpc%5D%0A&lt;li&gt;%20**zabs**:%20Redshift%20of%20the%20absorption%20feature%0A&lt;li&gt;%20**v-**:%20Lower%20edge%20of%20the%20absorption%20feature%20in%20velocity%20space%0A&lt;li&gt;%20**v+**:%20Upper%20edge%20of%20the%20absorption%20feature%20in%20velocity%20space%0A&lt;li&gt;%20**EW_r**:%20Rest%20frame%20equivalent%20width%20of%20the%20absorption%20feature%0A&lt;li&gt;%20**dEW_r**:%20Uncertainty%20in%20EW_r%0A&lt;li&gt;%20**DR**:%0A&lt;li&gt;%20**dDR**:%20Uncertainty%20in%20DR%0A&lt;li&gt;%20**SL**:%20Significance%20level%20of%20the%20detection%0A&lt;li&gt;%20**Vbar**:%20Mean%20velocity%20of%20the%20absorption%0A&lt;li&gt;%20**dVbar**:%20Uncertainty%20in%20Vbar%0A&lt;li&gt;%20**Vsprd**:%20Spread%20of%20the%20absorption%20in%20velocity%20space%0A&lt;li&gt;%20**dVsprd**:%20Uncertainty%20in%20Vsprd%0A&lt;li&gt;%20**Vasym**:%0A&lt;li&gt;%20**dVasym**:%20Uncertainty%20in%20Vasym%0A&lt;li&gt;%20**lgt**:%20%0A&lt;li&gt;%20**dtau-**:%20Lower%20uncertainty%20in%20optical%20depth%0A&lt;li&gt;%20**dtau+**:%20Upper%20uncertainty%20in%20optical%20depth%0A&lt;li&gt;%20**logN**:%20Log%20of%20column%20density%20of%20the%20absorption%0A&lt;li&gt;%20**dlogN-**:%20Lower%20uncertainty%20in%20logN%0A&lt;li&gt;%20*dlogN-**:%20Upper%20uncertainty%20in%20logN%0A&lt;/ul&gt;%0A%0A&lt;p&gt;Gasbox:&lt;/p&gt;%0A%0A&lt;ul&gt;%0A&lt;li&gt;%20**cell_size**:%20Size%20of%20the%20cell%20%5Bkpc%5D%0A&lt;li&gt;%20**x**:%20x-coordinate%20of%20the%20cell%20in%20box%20reference%20frame%20%5Bkpc%5D%0A&lt;li&gt;%20**y**:%20y-coordinate%20of%20the%20cell%20in%20box%20reference%20frame%20%5Bkpc%5D%0A&lt;li&gt;%20**z**:%20z-coordinate%20of%20the%20cell%20in%20box%20reference%20frame%20%5Bkpc%5D%0A&lt;li&gt;%20**vx**:%20vx%20component%20of%20the%20cell's%20velocity%20in%20box%20reference%20frame%20%5Bkm/s%5D%0A&lt;li&gt;%20**vy**:%20vy%20component%20of%20the%20cell's%20velocity%20in%20box%20reference%20frame%20%5Bkm/s%5D%0A&lt;li&gt;%20**vz**:%20vz%20component%20of%20the%20cell's%20velocity%20in%20box%20reference%20frame%20%5Bkm/s%5D%0A&lt;li&gt;%20**nH**:%20Gas%20density%20in%20the%20cell%20%5Bnum/cc%5D%0A&lt;li&gt;%20**temperature**:%20Temperature%20of%20gas%20in%20the%20cell%20%5BK%5D%0A&lt;li&gt;%20**SNII**:%20Contribution%20to%20the%20metal%20mass%20fraction%20from%20SNII%0A&lt;li&gt;%20**SNIa**:%20Contribution%20to%20the%20metal%20mass%20fraction%20from%20SNIa%0A&lt;li&gt;%20**nAtom**:%20Density%20of%20the%20element%20in%20question%20(such%20as%20carbon%20or%20oxygen)%20in%20the%20cell%20%5Bnum/cc%5D%0A&lt;li&gt;%20**fIon**:%20Ionization%20fraction%20of%20the%20ion%20in%20question%20within%20the%20cell%0A&lt;li&gt;%20**nIon**:%20Density%20of%20the%20ion%20in%20the%20cell%20%5Bnum/cc%5D%0A&lt;li&gt;%20**alpha_sol**:%20Solar%20abundance%20of%20the%20element%0A&lt;li&gt;%20**alpha_Zmet**:%20Abundance%20of%20the%20element%20in%20the%20cell%20relative%20to%20solar%0A&lt;li&gt;%20**ID**:%20Identification%20number%20of%20the%20cell%0A&lt;li&gt;%20**t_ph**:%20Timescale%20of%20photoionization%20in%20the%20cell%0A&lt;li&gt;%20**t_rec**:%20Timescale%20of%20recombination%20in%20the%20cell%0A&lt;li&gt;%20**t_coll**:%20Timescale%20of%20collisional%20ionization%20in%20the%20cell%0A&lt;li&gt;%20**t_cool**:%20Timescale%20of%20cooling%20in%20the%20cell%0A&lt;/ul&gt;"></a></p>
      </section>

      <footer>
        <span class="ribbon-outer">
          <span class="ribbon-inner">
            <p>this project by <a href="https://github.com/jrvliet">jrvliet</a> can be found on <a href="https://github.com/jrvliet/mockspec">GitHub</a></p>
          </span>
          <span class="left-tail"></span>
          <span class="right-tail"></span>
        </span>
        <p>Generated with <a href="https://pages.github.com">GitHub Pages</a> using Merlot</p>
        <span class="octocat"></span>
      </footer>

    </div>

    
  </body>
</html>
